<!DOCTYPE html>
<html>

<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Rubik&display=swap" rel="stylesheet">
  <style>
    :root {
      --text: #11080e;
      --background: #f3e7ef;
      --primary: #49c572;
      --secondary: #e0d7dd;
      --accent: #d5632a;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --text: #f7eef4;
        --background: #180c14;
        --primary: #3ab663;
        --secondary: #281f25;
        --accent: #d5632a;
      }
    }

    body {
      font-family: 'Rubik';
      font-weight: 400;
    }

    h1,
    h2,
    h3,
    h4,
    h5 {
      font-family: 'Comfortaa';
      font-weight: 700;
    }

    html {
      font-size: 100%;
    }

    /* 16px */
    @media (max-aspect-ratio: 1/1) {

      /*Mobile screen test*/
      html,
      * {
        font-size: max(100%, 2.5vw);
      }
    }

    h1 {
      font-size: 3.366rem;
      /* 53.92px */
    }

    h2 {
      font-size: 2.525rem;
      /* 40.32px */
    }

    h3 {
      font-size: 1.894rem;
      /* 30.24px */
    }

    h4 {
      font-size: 1.421rem;
      /* 22.72px */
    }

    h5 {
      font-size: 1.066rem;
      /* 17.12px */
    }

    small {
      font-size: 0.600rem;
      /* 9.6px */
    }

    body {
      display: flex;
      flex-flow: column;
      align-items: center;
      text-align: center;
      color: var(--text);
      background-color: var(--background);
    }

    details {
      border-radius: 4px;
      background-color: var(--primary);
      color: var(--background);
      width: 90%;
    }

    summary {
      font-weight: bold;
      padding: 1rem;
      display: block;
      padding-left: 2.2rem;
      position: relative;
      cursor: pointer;
    }

    summary:before {
      content: '';
      border-width: .4rem;
      border-style: solid;
      border-color: transparent transparent transparent #fff;
      position: absolute;
      top: 1.3rem;
      left: 1rem;
      transform: rotate(0);
      transform-origin: .2rem 50%;
      transition: .25s transform ease;
    }

    details[open]>summary:before {
      transform: rotate(90deg);
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details[open] {
      padding: 0 0 1em;
    }

    input,
    button,
    select {
      border: 0;
      border-radius: 4px;
      margin: 3px;
    }

    .bigbtn {
      font-size: 2.525rem;
      padding: .3em;
      background-color: var(--primary);
      color: var(--background);
      transition: filter .5s;
    }

    .bigbtn:hover {
      filter: brightness(0.85);
    }

    #qr {
      width: 10em;
      image-rendering: crisp-edges;
    }

    #pd {
      width: 90%;
      background-color: var(--accent);
      margin-top: 8vh;
      border-radius: 4px;
      color: var(--background);
    }
  </style>
</head>

<body>
  <h1 id="type"></h1>

  <h2 id="text"></h2>
  <p id="cert">Сертицировано ООО "ДРУЖНЫЙ БЕЛЫЙ КОТ" ИНН 5406305323</p>

  <details id="creator_folder">
    <summary>Создать свой сертификат</summary>
    <div id="creator" style="display:inline-block">
      <h3>Создать свой сертификат</h3>
      <form id="creator_form">
        <label for="name">Имя объекта: </label>
        <input type="text" id="name" name="name" required minlength="1" maxlength="20" />
        <br>
        <label for="type_select">Тип:</label>
        <select id="type_select" name="type_select" reqiured>
          <option id="generaltype" value="generaltype" selected required>Сертификот: Обычный</option>
          <option id="doctype" value="doctype" required>Сертификот: Деловой печатный документ</option>
          <option id="customtype" value="customtype" required>Сертифигав: Свой тип</option>
        </select>
        <div id="customtypeselect" style="display:none">
          <label for="customtypetype">Тип объекта: </label>
          <input type="text" id="customtypetype" name="customtypetype" required minlength="1" maxlength="20" />
        </div>
        <br>
        <label for="orgnameinp">Название организации: </label>
        <input type="text" id="orgnameinp" name="orgnameinp" required minlength="3" maxlength="20" />
        <br>
        <button id="create_btn" form>Создать</button>
        <div id="qrout" style="display:none">
          <h3>QR код:</h3>
          <img id="qr" fetchpriority="high">
        </div>
      </form>
    </div>
  </details>
  <div id="pd">
    <h1>Костя Премиум</h1>
    <h3>Создавайте сертификаты без ограничений!</h3>
    <p>Вы сможете создать свой уникальный сертификат!</p>
    <h4>Всего за <span id="premium_price">100000000</span>₽</h4>
    <label for="promocode">Промокод:</label>
    <input type="text" id="promocode" name="promocode" required minlength="1" maxlength="5" size="10"
      spellcheck="false" />
    <br>
    <button id="buy_premium" class="bigbtn">Купить</button>
  </div>
  <footer>
    <p>2023 Мякус Технолоджис <a
        href="https://howsmsmsuser.github.io/p.github.io/?n=%D1%82%D0%B5%D1%81%D1%82&o=%D0%A1%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%BE%D1%82&t=0&c=rRsS_2pR-1-Bb5H2Db-M-5GoZiCUdh5VnKIfMkx5Ho_4l8UPqppCtgRs0qBZpeKuWJCCgDOzK47bKLkKC0t4Uw.0!%D0%A1%D0%9E%D0%9F%D0%B5%D1%87%D0%B0%D1%82%D1%8C.rRsS_2pR-1-Bb5H2Db-M-5GoZiCUdh5VnKIfMkx5Ho_4l8UPqppCtgRs0qBZpeKuWJCCgDOzK47bKLkKC0t4Uw.0">Тестовый
        сертификат</a>
    </p>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack@2"></script>
  <script>
    var INCLUDEORGS = 2; // Include 2 random orgs in the link
    // Chooses k unique random elements from pool.
    function arr_sample(pool, k, destructive) {
      var n = pool.length;

      if (k < 0 || k > n)
        throw new RangeError("Sample larger than population or is negative");

      if (destructive || n <= (k <= 5 ? 21 : 21 + Math.pow(4, Math.ceil(Math.log(k * 3) / Math.log(4))))) {
        if (!destructive)
          pool = Array.prototype.slice.call(pool);
        for (var i = 0; i < k; i++) { // invariant: non-selected at [i,n)
          var j = i + Math.random() * (n - i) | 0;
          var x = pool[i];
          pool[i] = pool[j];
          pool[j] = x;
        }
        pool.length = k; // truncate
        return pool;
      } else {
        var selected = new Set();
        while (selected.add(Math.random() * n | 0).size < k) { }
        return Array.prototype.map.call(selected, i => pool[i]);
      }
    }
    function arr_intersect(a, b) {
      let setB = new Set(b);
      return [...new Set(a)].filter(x => setB.has(x));
    }
    function arr_random_favor_1st(array) {
      return array[Math.round((Math.random() * Math.sqrt(array.length - 1)) ** 2)]
    }
    const obj_omit = (obj, prop) => {
      let { [prop]: omit, ...res } = obj
      return res
    }
    function typedArrayToBuffer(array) {
      return array.buffer.slice(array.byteOffset, array.byteLength + array.byteOffset)
    }
    // note: `buffer` arg can be an ArrayBuffer or a Uint8Array
    async function bufferToBase64(buffer) {
      // use a FileReader to generate a base64 data URI:
      const base64url = await new Promise(r => {
        const reader = new FileReader()
        reader.onload = () => r(reader.result)
        reader.readAsDataURL(new Blob([buffer]))
      });
      // remove the `data:...;base64,` part from the start
      return base64url.slice(base64url.indexOf(',') + 1);
    }
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('n');
    const type = urlParams.get('t');
    console.log(name, type);
    const type_text = document.getElementById("type");
    const text_text = document.getElementById("text");
    const cert_text = document.getElementById("cert");
    const creator_form = document.getElementById("creator_form");
    const creator_folder = document.getElementById("creator_folder");
    const create_btn = document.getElementById("create_btn");
    const qr = document.getElementById("qr");
    const qrout = document.getElementById("qrout");
    const ad = document.getElementById("pd");
    const promo = document.getElementById("promocode");
    const premiumprice = document.getElementById("premium_price");
    const customtypeselect = document.getElementById("customtypeselect");
    var hasPremium = localStorage.getItem("premium") === "kostya";
    if (localStorage.getItem("orgs") === null) localStorage.setItem("orgs", "{}");
    var trustedOrgs = JSON.parse(localStorage.getItem("orgs"));
    function saveOrgs() {
      localStorage.setItem("orgs", JSON.stringify(trustedOrgs)); // Save orgs
    }
    function encodepubjwk(jwk) {
      return jwk.n;
    }
    function decodepubjwk(encoded, key_ops = ["verify"]) {
      return {
        alg: "PS256",
        e: "AQAB",
        ext: true,
        key_ops: key_ops,
        kty: "RSA",
        n: encoded
      }
    }
    function encodeurlorgs(thisorgentry, randomorgs) {
      // Orgs format: thisorgkey.thisorguses!1orgencodedname.1orgkey.1orguses!2orgencodedname.2orgkey.2orguses
      combinedrandomorgs = randomorgs.map((org) => encodeURIComponent(org[0]).replaceAll("!", "%21").replaceAll(".", "%2E") + "." + encodepubjwk(org[1].key) + "." + org[1].uses);
      thisorgcombined = encodepubjwk(thisorgentry.key) + "." + thisorgentry.uses;
      combinedorgs = thisorgcombined + "!" + combinedrandomorgs.join("!");
      console.debug("combined all org keys:", combinedorgs);
      console.info("this org's key takes up", thisorgcombined.length, "characters, and random orgs take up", combinedorgs.length - thisorgcombined.length);
      return combinedorgs;
    }
    var key;
    if (localStorage.getItem("privatekey") === null || localStorage.getItem("publickey") === null) {
      crypto.subtle.generateKey(
        {
          name: "RSA-PSS",
          modulusLength: 512,
          publicExponent: new Uint8Array([1, 0, 1]),
          hash: "SHA-256",
        },
        true,
        ["sign", "verify"]
      ).then((keyPair) => {
        key = keyPair;
        crypto.subtle.exportKey("jwk", key.publicKey).then((jwkobject) => { localStorage.setItem("publickey", JSON.stringify(jwkobject)) });
        crypto.subtle.exportKey("jwk", key.privateKey).then((jwkobject) => { localStorage.setItem("privatekey", JSON.stringify(jwkobject)) });
      });
    } else {
      key = {}
      crypto.subtle.importKey("jwk", JSON.parse(localStorage.getItem("publickey")), { name: "RSA-PSS", hash: "SHA-256", }, true, ["verify"]).then((pubkey) => { key.publicKey = pubkey });
      crypto.subtle.importKey("jwk", JSON.parse(localStorage.getItem("privatekey")), { name: "RSA-PSS", hash: "SHA-256", }, false, ["sign"]).then((privkey) => { key.privateKey = privkey });
    }
    if (hasPremium) ad.style.display = "none";
    if (promo.value.toLowerCase() == "10мяу") premiumprice.innerText = "0";
    if (creator_form.elements["type_select"].value == "customtype") {
      customtypeselect.style.display = "block";
      creator_form.elements["customtypetype"].removeAttribute("readonly");
    } else {
      customtypeselect.style.display = "none";
      creator_form.elements["customtypetype"].setAttribute("readonly", "");
    }

    create_btn.addEventListener("click", e => {
      if (!creator_form.reportValidity()) return;
      orgname = creator_form.elements["orgnameinp"].value;
      customparams = "";
      textenc = new TextEncoder();
      all_data = new Uint8Array();
      if (creator_form.elements["type_select"].value == "customtype") {
        if (!hasPremium) {
          alert("Сертифигав доступен только с Костя Премиум");
          return;
        }
        customparams += `c=${encodeURIComponent(creator_form.elements["customtypetype"].value)}`;
        textenc.encodeInto(creator_form.elements["customtypetype"].value, all_data);
      }
      textenc.encodeInto(creator_form.elements["type_select"].selectedIndex + creator_form.elements["name"].value + "0" + orgname, all_data);
      crypto.subtle.sign(
        {
          name: "RSA-PSS",
          saltLength: 16,
        },
        key.privateKey,
        typedArrayToBuffer(all_data)
      ).then((signature) => {
        bufferToBase64(signature).then((signatureb64) => {
          crypto.subtle.exportKey("jwk", key.publicKey).then((jwkobject) => {
            if (!(orgname in trustedOrgs)) trustedOrgs[orgname] = [];
            entries_with_key = trustedOrgs[orgname].filter((entry) => { entry["key"] == jwkobject });
            if (entries_with_key.length) {
              // Increment key uses when signing (probably bad)
              //for (entry of entries_with_key) {entry["uses"]++}
              thisorgentry = entries_with_key[0];
            } else {
              thisorgentry = { // Default org data
                "key": jwkobject,
                "uses": 0
              }
              trustedOrgs[orgname].unshift(thisorgentry);
            };
            console.debug("signed cert, all trusted orgs now are:", trustedOrgs);
            saveOrgs();
            trustedOrgslen = Object.keys(trustedOrgs).length
            if (INCLUDEORGS && trustedOrgslen - 1 >= 1) { // If we can take a sample
              randomorgs = arr_sample(Object.entries(obj_omit(trustedOrgs, orgname)), Math.min(trustedOrgslen - 1, INCLUDEORGS), false).map((org) => [org[0], arr_random_favor_1st(org[1].toSorted((a, b) => { b.uses - a.uses }))]);
              console.info("Included random orgs:", randomorgs);
            } else {
              randomorgs = [];
            }
            combinedorgs = encodeurlorgs(thisorgentry, randomorgs);
            customparams += `c=${combinedorgs}&s=${signatureb64}`;

            url = `https://howsmsmsuser.github.io/p.github.io/?n=${encodeURIComponent(creator_form.elements["name"].value)}&o=${encodeURIComponent(orgname)}&t=${creator_form.elements["type_select"].selectedIndex}&${customparams}`;
            console.info("url:", url)
            qrurl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(url)}&size=300x300`;
            qrout.style.display = "block";
            qr.src = qrurl;
          });
        });
      });
    })
    creator_form.elements["type_select"].addEventListener("change", e => {
      if (e.target.value == "customtype") {
        if (!hasPremium) {
          alert("Сертифигав доступен только с Костя Премиум");
          return;
        }
        customtypeselect.style.display = "block";
        creator_form.elements["customtypetype"].removeAttribute("readonly");
      } else {
        customtypeselect.style.display = "none";
        creator_form.elements["customtypetype"].setAttribute("readonly", "");
      }
    })
    promo.addEventListener("input", e => {
      if (e.target.value.toLowerCase() == "10мяу") {
        premiumprice.innerText = "0";
      } else {
        premiumprice.innerText = "100000000";
      }
    })
    document.getElementById("buy_premium").addEventListener("click", e => {
      if (promo.value.toLowerCase() == "10мяу") {
        localStorage.setItem("premium", "kostya");
        hasPremium = true;
        ad.style.display = "none";
        alert("Вы купили Костя Премиум!");
      } else {
        alert("У вас таких денег нет.");
      }
    })
    switch (type) {
      case '0':
        type_text.innerText = "Сертификот";
        text_text.innerText = `Объект ${name} сертифицирован`;
        break
      case '1':
        type_text.innerText = "Сертификот";
        text_text.innerText = `Объект ${name} утверждён как "Деловой печатный документ"`;
        break
      case '2':
        type_text.innerText = "Сертифигав";
        text_text.innerText = `Объект ${name} сертифицирован как ${urlParams.get('c')}`;
        break
      case null:
        type_text.innerText = "";
        cert_text.innerText = "";
        creator_folder.open = true;
        break
      default:
        type_text.innerText = "Ошибка";
        cert_text.innerText = "";
        break
    }
  </script>
</body>

</html>